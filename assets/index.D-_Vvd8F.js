var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const i=18,s=12,n=.45,a=.4,r=768,o=3,c=100,l=.5;function h(){const e=function(){const e=window.innerWidth<r?a:n,t=window.innerHeight*e;return Math.floor(t/i)}();return{width:s*e,height:i*e,cellSize:e}}class d{constructor(){t(this,"_occupied",!1),t(this,"_color",null),t(this,"_pieceId",null)}get occupied(){return this._occupied}get color(){return this._color}get pieceId(){return this._pieceId}fill(e,t){this._occupied=!0,this._color=e,this._pieceId=t}clear(){this._occupied=!1,this._color=null,this._pieceId=null}isEmpty(){return!this._occupied}toData(){return{occupied:this._occupied,color:this._color,pieceId:this._pieceId}}static fromData(e){const t=new d;return e.occupied&&e.color&&e.pieceId&&t.fill(e.color,e.pieceId),t}}class u{static isValidPosition(e,t,i,s){return e>=0&&e<i&&t>=0&&t<s}static canPlacePiece(e,t,i,s){const n=e.length,a=e[0].length;for(let r=0;r<t.length;r++)for(let o=0;o<t[r].length;o++)if(t[r][o]){const t=i+r,c=s+o;if(!this.isValidPosition(t,c,n,a))return!1;if(e[t][c].occupied)return!1}return!0}static getOccupiedPositions(e,t,i){const s=[];for(let n=0;n<e.length;n++)for(let a=0;a<e[n].length;a++)e[n][a]&&s.push({row:t+n,col:i+a});return s}}class g{constructor(){t(this,"cells"),t(this,"rows",i),t(this,"cols",s),this.cells=this.initializeGrid()}initializeGrid(){const e=[];for(let t=0;t<this.rows;t++){e[t]=[];for(let i=0;i<this.cols;i++)e[t][i]=new d}return e}getCells(){return this.cells}getCell(e,t){return e<0||e>=this.rows||t<0||t>=this.cols?null:this.cells[e][t]}canPlacePiece(e,t,i){return u.canPlacePiece(this.cells,e,t,i)}placePiece(e,t,i,s,n){const a=u.getOccupiedPositions(e,t,i);for(const r of a)this.cells[r.row][r.col].fill(s,n)}getCompleteLines(){const e=[],t=[];for(let i=0;i<this.rows;i++)this.isRowComplete(i)&&e.push(i);for(let i=0;i<this.cols;i++)this.isColumnComplete(i)&&t.push(i);return{rows:e,cols:t}}isRowComplete(e){for(let t=0;t<this.cols;t++)if(this.cells[e][t].isEmpty())return!1;return!0}isColumnComplete(e){for(let t=0;t<this.rows;t++)if(this.cells[t][e].isEmpty())return!1;return!0}clearLines(e,t){for(const i of e)for(let e=0;e<this.cols;e++)this.cells[i][e].occupied&&this.cells[i][e].clear();for(const i of t)for(let e=0;e<this.rows;e++)this.cells[e][i].occupied&&this.cells[e][i].clear();return e.length+t.length}applyGravity(){let e=!1;for(let t=0;t<this.cols;t++){let i=this.rows-1;for(let s=this.rows-1;s>=0;s--)if(this.cells[s][t].occupied){if(s!==i){const n=this.cells[s][t].toData();this.cells[i][t].fill(n.color,n.pieceId),this.cells[s][t].clear(),e=!0}i--}}return e}isFull(){for(let e=0;e<this.cols;e++)if(this.cells[0][e].occupied)return!0;return!1}serialize(){return this.cells.map(e=>e.map(e=>e.toData()))}static deserialize(e){const t=new g;for(let i=0;i<t.rows;i++)for(let s=0;s<t.cols;s++)t.cells[i][s]=d.fromData(e[i][s]);return t}clear(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.cols;t++)this.cells[e][t].clear()}}class m{constructor(){t(this,"score",0),t(this,"comboMultiplier",1),t(this,"totalLinesCleared",0)}addScore(e,t){const i=e*c,s=1+t*l,n=Math.floor(i*s);return this.score+=n,this.comboMultiplier=s,this.totalLinesCleared+=e,n}getScore(){return this.score}getComboMultiplier(){return this.comboMultiplier}getTotalLinesCleared(){return this.totalLinesCleared}reset(){this.score=0,this.comboMultiplier=1,this.totalLinesCleared=0}resetCombo(){this.comboMultiplier=1}}class f{constructor(){t(this,"cascadeLevel",0)}detectLines(e){const t=e.getCompleteLines();return 0===t.rows.length+t.cols.length?null:t}clearLines(e,t){const i=t.rows.length+t.cols.length;return e.clearLines(t.rows,t.cols),this.cascadeLevel++,i}processCascade(e){let t=0;for(this.cascadeLevel=0;;){const i=e.getCompleteLines(),s=i.rows.length+i.cols.length;if(0===s)break;e.clearLines(i.rows,i.cols),t+=s,this.cascadeLevel++}return{cascadeLevel:this.cascadeLevel,totalLinesCleared:t,scoreAdded:0}}getCascadeLevel(){return this.cascadeLevel}reset(){this.cascadeLevel=0}}class p{constructor(e,i){t(this,"id"),t(this,"definition"),this.id=i||this.generateId(),this.definition=e}generateId(){return`piece_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}get shape(){return this.definition.shape}get color(){return this.definition.color}get width(){return this.definition.shape[0].length}get height(){return this.definition.shape.length}toData(){return{id:this.id,definition:this.definition}}static fromData(e){return new p(e.definition,e.id)}}const S=["#D84315","#E64A19","#FF5722","#F4511E","#D84315"],v="#4CAF50",b="#F44336",w={0:[[!0,!1],[!0,!1],[!0,!0]],90:[[!0,!0,!0],[!0,!1,!1]],180:[[!0,!0],[!1,!0],[!1,!0]],270:[[!1,!1,!0],[!0,!0,!0]]},y={0:[[!0],[!0],[!0],[!0]],90:[[!0,!0,!0,!0]],180:[[!0],[!0],[!0],[!0]],270:[[!0,!0,!0,!0]]},E={0:[[!1,!0,!0],[!0,!0,!1]],90:[[!0,!1],[!0,!0],[!1,!0]],180:[[!1,!0,!0],[!0,!0,!1]],270:[[!0,!1],[!0,!0],[!1,!0]]},x={0:[[!0,!0,!0],[!1,!0,!1]],90:[[!1,!0],[!0,!0],[!1,!0]],180:[[!1,!0,!1],[!0,!0,!0]],270:[[!0,!1],[!0,!0],[!0,!1]]};function P(e){return Array(e).fill(null).map(()=>Array(e).fill(!0))}const C=[],M=[0,90,180,270];M.forEach((e,t)=>{C.push({type:"TETROMINO_L",shape:w[e],color:S[0],rotation:e,size:0})}),M.forEach((e,t)=>{C.push({type:"TETROMINO_I",shape:y[e],color:S[1],rotation:e,size:0})}),M.forEach((e,t)=>{C.push({type:"TETROMINO_F",shape:E[e],color:S[2],rotation:e,size:0})}),M.forEach((e,t)=>{C.push({type:"TETROMINO_T",shape:x[e],color:S[3],rotation:e,size:0})});for(let te=1;te<=6;te++)C.push({type:"SQUARE",shape:P(te),color:S[4],rotation:0,size:te});class L{createRandomPiece(){const e=Math.floor(Math.random()*C.length);return new p(C[e])}createPieceByIndex(e){if(e<0||e>=C.length)throw new Error(`Invalid piece index: ${e}`);return new p(C[e])}createMultiplePieces(e){const t=[];for(let i=0;i<e;i++)t.push(this.createRandomPiece());return t}}class I{constructor(){t(this,"factory"),t(this,"availablePieces"),t(this,"selectedIndex",-1),this.factory=new L,this.availablePieces=this.factory.createMultiplePieces(o)}getAvailablePieces(){return this.availablePieces}selectPiece(e){return e<0||e>=this.availablePieces.length?null:(this.selectedIndex=e,this.availablePieces[e])}consumePiece(e){if(e<0||e>=this.availablePieces.length)return null;const t=this.availablePieces[e];return this.availablePieces[e]=this.factory.createRandomPiece(),this.selectedIndex=-1,t}getSelectedIndex(){return this.selectedIndex}clearSelection(){this.selectedIndex=-1}hasAvailablePieces(){return this.availablePieces.length>0}hasPlayablePieces(e){for(const t of this.availablePieces)for(let i=0;i<18;i++)for(let s=0;s<12;s++)if(e.canPlacePiece(t.shape,i,s))return!0;return!1}reset(){this.availablePieces=this.factory.createMultiplePieces(o),this.selectedIndex=-1}}function D(e){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle="#FFF8E1",e.fillRect(0,0,e.canvas.width,e.canvas.height)}class A{constructor(e){t(this,"canvas"),t(this,"ctx"),t(this,"cellSize"),this.canvas=e;const i=e.getContext("2d");if(!i)throw new Error("Could not get 2d context");this.ctx=i;const s=h();this.cellSize=s.cellSize,e.width=s.width,e.height=s.height}render(e){this.clear(),this.drawGrid(),this.drawCells(e)}clear(){D(this.ctx)}drawGrid(){this.ctx.strokeStyle="rgba(141, 110, 99, 0.3)",this.ctx.lineWidth=.5;for(let e=0;e<=18;e++){const t=e*this.cellSize;this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(12*this.cellSize,t),this.ctx.stroke()}for(let e=0;e<=12;e++){const t=e*this.cellSize;this.ctx.beginPath(),this.ctx.moveTo(t,0),this.ctx.lineTo(t,18*this.cellSize),this.ctx.stroke()}}drawCells(e){for(let t=0;t<e.length;t++)for(let i=0;i<e[t].length;i++){const s=e[t][i];s.occupied&&s.color&&this.drawCell(t,i,s.color)}}drawCell(e,t,i){const s=t*this.cellSize,n=e*this.cellSize;this.ctx.fillStyle=i,this.ctx.fillRect(s+1,n+1,this.cellSize-2,this.cellSize-2)}drawCellWithAnimation(e,t,i,s){const n=t*this.cellSize,a=e*this.cellSize,r=this.cellSize-2;this.ctx.save();const o=s*(.6*this.cellSize),c=Math.max(0,1-1.2*s),l=Math.max(0,1-.8*s),h=s*Math.PI*.5;this.ctx.globalAlpha=c;const d=r/2,u=n+this.cellSize/2,g=a+this.cellSize/2;[{offsetX:-1,offsetY:-1},{offsetX:1,offsetY:-1},{offsetX:-1,offsetY:1},{offsetX:1,offsetY:1}].forEach(({offsetX:e,offsetY:t})=>{this.ctx.save();const s=u+e*o,n=g+t*o;this.ctx.translate(s,n),this.ctx.rotate(h*e*t),this.ctx.fillStyle=i,this.ctx.fillRect(-d*l/2,-d*l/2,d*l,d*l),this.ctx.restore()}),this.ctx.restore()}getCellSize(){return this.cellSize}getCanvas(){return this.canvas}}class T{static renderPiece(e,t,i,s,n,a=1){e.save(),e.globalAlpha=a;const r=t.shape,o=t.color;for(let c=0;c<r.length;c++)for(let t=0;t<r[c].length;t++)if(r[c][t]){const a=i+t*n,r=s+c*n;e.fillStyle=o,e.fillRect(a+1,r+1,n-2,n-2),e.strokeStyle="rgba(0, 0, 0, 0.2)",e.lineWidth=1,e.strokeRect(a+1,r+1,n-2,n-2)}e.restore()}static getPieceDimensions(e,t){return{width:e[0].length*t,height:e.length*t}}static renderPieceCentered(e,t,i,s,n,a=1){const r=this.getPieceDimensions(t.shape,n),o=i-r.width/2,c=s-r.height/2;this.renderPiece(e,t,o,c,n,a)}}class R{constructor(e,i){t(this,"ctx"),t(this,"cellSize"),t(this,"SLOTS",3),t(this,"pieceSpacing"),t(this,"MAX_PIECE_SIZE",6),t(this,"canvasWidth"),t(this,"canvasHeight"),t(this,"isVerticalLayout");const s=e.getContext("2d");if(!s)throw new Error("Could not get 2d context for panel");this.ctx=s;const n=window.innerWidth,a=n<768;this.isVerticalLayout=a,n<=380?(this.pieceSpacing=8,this.cellSize=1.25*i):a?(this.pieceSpacing=12,this.cellSize=i):(this.pieceSpacing=40,this.cellSize=i);const r=this.MAX_PIECE_SIZE*this.cellSize;this.isVerticalLayout?(this.canvasWidth=r,this.canvasHeight=r*this.SLOTS+this.pieceSpacing*(this.SLOTS-1)):(this.canvasWidth=r*this.SLOTS+this.pieceSpacing*(this.SLOTS-1),this.canvasHeight=r),e.width=this.canvasWidth,e.height=this.canvasHeight}render(e,t){this.clear(),this.drawPieces(e)}clear(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}drawPieces(e){const t=this.MAX_PIECE_SIZE*this.cellSize;for(let i=0;i<Math.min(e.length,this.SLOTS);i++){const s=e[i];let n,a;this.isVerticalLayout?(n=this.canvasWidth/2,a=t/2+i*(t+this.pieceSpacing)):(n=t/2+i*(t+this.pieceSpacing),a=this.canvasHeight/2),T.renderPieceCentered(this.ctx,s,n,a,this.cellSize)}}getSlotIndexFromCoordinates(e,t){const i=this.MAX_PIECE_SIZE*this.cellSize;if(this.isVerticalLayout){if(e<0||e>this.canvasWidth)return-1;for(let e=0;e<this.SLOTS;e++){const s=e*(i+this.pieceSpacing);if(t>=s&&t<s+i)return e}}else{if(t<0||t>this.canvasHeight)return-1;for(let t=0;t<this.SLOTS;t++){const s=t*(i+this.pieceSpacing);if(e>=s&&e<s+i)return t}}return-1}getCellSize(){return this.cellSize}}class z{constructor(e,i){t(this,"ctx"),t(this,"cellSize");const s=e.getContext("2d");if(!s)throw new Error("Could not get 2d context for effects");this.ctx=s,this.cellSize=i}render(e){this.clear();for(const t of e)switch(t.type){case"CLEAR_LINE":this.renderClearEffect(t);break;case"GLOW":this.renderGlowEffect(t);break;case"FALL":this.renderFallEffect(t)}}clear(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}renderClearEffect(e){const{row:t,col:i}=e.position,s=i*this.cellSize,n=t*this.cellSize;if(this.ctx.save(),this.ctx.globalAlpha=1-e.progress,this.ctx.fillStyle="#FFD700",this.ctx.fillRect(s,n,this.cellSize,this.cellSize),e.progress<.5){this.ctx.globalAlpha=.8,this.ctx.strokeStyle=e.color,this.ctx.lineWidth=3;const t=this.cellSize*(1+2*e.progress),i=(t-this.cellSize)/2;this.ctx.strokeRect(s-i,n-i,t,t)}this.ctx.restore()}renderGlowEffect(e){const{row:t,col:i}=e.position,s=i*this.cellSize+this.cellSize/2,n=t*this.cellSize+this.cellSize/2;this.ctx.save();const a=.5+.3*Math.sin(e.progress*Math.PI*4);this.ctx.globalAlpha=a,this.ctx.shadowBlur=20,this.ctx.shadowColor=e.color,this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(s,n,this.cellSize/3,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}renderFallEffect(e){const{row:t,col:i}=e.position,s=i*this.cellSize,n=t*this.cellSize;this.ctx.save(),this.ctx.globalAlpha=.3*(1-e.progress),this.ctx.fillStyle=e.color,this.ctx.fillRect(s,n-this.cellSize*e.progress,this.cellSize,this.cellSize*e.progress),this.ctx.restore()}updateSize(e){this.cellSize=e}}class B{updateScore(e){const t=document.getElementById("score");t&&(t.textContent=e.toString())}updateCombo(e){const t=document.getElementById("combo");t&&(t.textContent=`${e.toFixed(1)}x`,e>1?t.classList.add("combo-active"):t.classList.remove("combo-active"))}updateHighScore(e){const t=document.getElementById("high-score-display");t&&(t.textContent=e.toString())}showMessage(e,t=2e3){const i=document.createElement("div");i.className="game-message",i.textContent=e,document.body.appendChild(i),setTimeout(()=>{i.remove()},t)}}class G{constructor(e){t(this,"lastTime",0),t(this,"animationId",null),t(this,"callback"),t(this,"isRunning",!1),t(this,"loop",()=>{if(!this.isRunning)return;const e=performance.now(),t=e-this.lastTime;this.lastTime=e,this.callback(t),this.animationId=requestAnimationFrame(this.loop)}),this.callback=e}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.loop())}stop(){this.isRunning=!1,null!==this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}isActive(){return this.isRunning}}class k{constructor(){t(this,"dragState",{piece:null,startX:0,startY:0,currentX:0,currentY:0,isDragging:!1,isValid:!1,gridRow:0,gridCol:0})}startDrag(e,t,i){this.dragState={piece:e,startX:t,startY:i,currentX:t,currentY:i,isDragging:!0,isValid:!1,gridRow:0,gridCol:0}}updateDrag(e,t,i,s){if(!this.dragState.isDragging||!this.dragState.piece)return;this.dragState.currentX=e,this.dragState.currentY=t;const n=this.screenToGrid(e,t,s);this.dragState.gridRow=n.row,this.dragState.gridCol=n.col,this.dragState.isValid=i.canPlacePiece(this.dragState.piece.shape,n.row,n.col)}endDrag(){if(!this.dragState.isDragging||!this.dragState.piece||!this.dragState.isValid)return this.cancelDrag(),null;const e={piece:this.dragState.piece,row:this.dragState.gridRow,col:this.dragState.gridCol};return this.cancelDrag(),e}cancelDrag(){this.dragState={piece:null,startX:0,startY:0,currentX:0,currentY:0,isDragging:!1,isValid:!1,gridRow:0,gridCol:0}}getDragState(){return{...this.dragState}}isDragging(){return this.dragState.isDragging}screenToGrid(e,t,i){return{row:Math.floor(t/i),col:Math.floor(e/i)}}}class N{constructor(e,i){t(this,"dragHandler"),t(this,"cellSize"),t(this,"boardCanvas"),t(this,"panelCanvas",null),t(this,"onPiecePlaced",null),t(this,"onPieceSelected",null),this.boardCanvas=e,this.cellSize=i,this.dragHandler=new k,this.setupEventListeners()}setPanelCanvas(e){this.panelCanvas=e}setCallbacks(e,t){this.onPiecePlaced=e,this.onPieceSelected=t}setupEventListeners(){this.boardCanvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.boardCanvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.boardCanvas.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),this.boardCanvas.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this.boardCanvas.addEventListener("touchend",this.handleTouchEnd.bind(this))}startDragFromPanel(e,t){const i=this.boardCanvas.getBoundingClientRect(),s=t.clientX-i.left,n=t.clientY-i.top;this.dragHandler.startDrag(e,s,n)}updateDrag(e){}handleMouseDown(e){}handleMouseMove(e){if(!this.dragHandler.isDragging())return;const t=this.boardCanvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;this.dragHandler.dragState.currentX=i,this.dragHandler.dragState.currentY=s}handleMouseUp(e){if(!this.dragHandler.isDragging())return;const t=this.dragHandler.endDrag();t&&this.onPiecePlaced&&this.onPiecePlaced(t.piece,t.row,t.col)}handleTouchStart(e){if(e.preventDefault(),0===e.touches.length)return;const t=e.touches[0],i=this.boardCanvas.getBoundingClientRect(),s=t.clientX-i.left,n=t.clientY-i.top;this.triggerHaptic("light"),this.dragHandler.dragState.currentX=s,this.dragHandler.dragState.currentY=n}handleTouchMove(e){if(e.preventDefault(),!this.dragHandler.isDragging()||0===e.touches.length)return;const t=e.touches[0],i=this.boardCanvas.getBoundingClientRect(),s=t.clientX-i.left,n=t.clientY-i.top;this.dragHandler.dragState.currentX=s,this.dragHandler.dragState.currentY=n}handleTouchEnd(e){if(!this.dragHandler.isDragging())return;this.triggerHaptic("medium");const t=this.dragHandler.endDrag();t&&this.onPiecePlaced&&this.onPiecePlaced(t.piece,t.row,t.col)}triggerHaptic(e){if("vibrate"in navigator){const t={light:10,medium:20,heavy:30};navigator.vibrate(t[e])}}getDragHandler(){return this.dragHandler}updateCellSize(e){this.cellSize=e}}class O{static render(e,t,i,s,n,a){const r=a?v:b;e.save(),e.shadowBlur=20,e.shadowColor=r,e.globalAlpha=.5;for(let o=0;o<t.length;o++)for(let a=0;a<t[o].length;a++)if(t[o][a]){const t=(s+a)*n,c=(i+o)*n;e.strokeStyle=r,e.lineWidth=3,e.strokeRect(t+2,c+2,n-4,n-4),e.fillStyle=r,e.globalAlpha=.3,e.fillRect(t+3,c+3,n-6,n-6),e.globalAlpha=.5}e.restore()}}class H{constructor(){t(this,"animations",[]),t(this,"animationDuration",250),t(this,"staggerDelay",60)}scheduleClearing(e,t,i){this.animations=[];const s=Date.now(),n=new Map;e.forEach(e=>{for(let t=0;t<12;t++){const s=`${e},${t}`,a=i.getCell(e,t);if(a&&a.occupied){const i=n.get(s),r=t*this.staggerDelay;(!i||r<i.delay)&&n.set(s,{row:e,col:t,delay:r,color:a.color||"#8B4513"})}}}),t.forEach(e=>{for(let t=0;t<18;t++){const s=`${t},${e}`,a=i.getCell(t,e);if(a&&a.occupied){const i=n.get(s),r=t*this.staggerDelay;(!i||r<i.delay)&&n.set(s,{row:t,col:e,delay:r,color:a.color||"#8B4513"})}}}),n.forEach(({row:e,col:t,delay:i,color:n})=>{this.animations.push({row:e,col:t,startTime:s+i,duration:this.animationDuration,color:n})})}getBlockProgress(e,t){const i=this.animations.find(i=>i.row===e&&i.col===t);if(!i)return null;const s=Date.now()-i.startTime;return s<0?0:s>=i.duration?1:s/i.duration}isAnimating(){if(0===this.animations.length)return!1;const e=Date.now();return this.animations.some(t=>e<t.startTime+t.duration)}getTotalDuration(){if(0===this.animations.length)return 0;return Math.max(...this.animations.map(e=>e.startTime+e.duration))-Math.min(...this.animations.map(e=>e.startTime))}getActiveAnimations(){const e=Date.now();return this.animations.filter(t=>{const i=e-t.startTime;return i>=0&&i<t.duration})}clear(){this.animations=[]}}var Y=(e=>(e.LOADING="LOADING",e.PLAYING="PLAYING",e.PAUSED="PAUSED",e.GAME_OVER="GAME_OVER",e))(Y||{});class _{constructor(){t(this,"dbName","PurrfectBlocksDB"),t(this,"dbVersion",2),t(this,"storeName","gameState"),t(this,"db",null)}async init(){return new Promise((e,t)=>{const i=indexedDB.open(this.dbName,this.dbVersion);let s=!1,n=null;const a=()=>{null!==n&&(clearTimeout(n),n=null)};i.onerror=()=>{s||(s=!0,a(),t(i.error))},i.onblocked=()=>{null!==n&&clearTimeout(n),n=window.setTimeout(()=>{s||(s=!0,t(new Error("Database blocked: Please close other tabs with this app open")))},1e4)},i.onsuccess=()=>{s||(s=!0,a(),this.db=i.result,e())},i.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.storeName)||t.createObjectStore(this.storeName,{keyPath:"id"})},n=window.setTimeout(()=>{s||(s=!0,t(new Error("Database initialization timeout")))},1e4)})}async saveGame(e){if(!this.db)throw new Error("Database not initialized");if(!this.db.objectStoreNames.contains(this.storeName))throw new Error("Database corrupted: object store missing");return new Promise((t,i)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),n={id:"current",...e},a=s.put(n);a.onsuccess=()=>{t()},a.onerror=()=>{i(a.error)}})}async loadGame(){if(!this.db)throw new Error("Database not initialized");if(!this.db.objectStoreNames.contains(this.storeName))throw new Error("Database corrupted: object store missing");return new Promise((e,t)=>{try{const i=this.db.transaction([this.storeName],"readonly"),s=i.objectStore(this.storeName).get("current");s.onsuccess=()=>{s.result?e(s.result):e(null)},s.onerror=()=>{t(s.error)},i.onerror=()=>{t(i.error)}}catch(i){t(i)}})}async deleteSave(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete("current");i.onsuccess=()=>{e()},i.onerror=()=>{t(i.error)}})}async hasSavedGame(){return null!==await this.loadGame()}async resetDatabase(){return new Promise((e,t)=>{this.db&&(this.db.close(),this.db=null),this.dbVersion++;const i=indexedDB.deleteDatabase(this.dbName);i.onsuccess=async()=>{try{await this.init(),e()}catch(i){t(i)}},i.onerror=()=>{this.init().then(e).catch(t)},i.onblocked=()=>{setTimeout(()=>{this.init().then(e).catch(t)},100)}})}}class F{constructor(){t(this,"context",null),t(this,"masterGain",null),t(this,"volume",.5),t(this,"muted",!1)}init(){if(!this.context)try{this.context=new AudioContext,this.masterGain=this.context.createGain(),this.masterGain.connect(this.context.destination),this.masterGain.gain.value=this.volume}catch(e){}}async resume(){this.context&&"suspended"===this.context.state&&await this.context.resume()}setVolume(e){this.volume=Math.max(0,Math.min(1,e)),this.masterGain&&!this.muted&&(this.masterGain.gain.value=this.volume)}getVolume(){return this.volume}setMuted(e){this.muted=e,this.masterGain&&(this.masterGain.gain.value=e?0:this.volume)}isMuted(){return this.muted}playTone(e,t,i="sine"){if(!this.context||!this.masterGain||this.muted)return;const s=this.context.createOscillator(),n=this.context.createGain();s.type=i,s.frequency.value=e;const a=this.context.currentTime;n.gain.setValueAtTime(0,a),n.gain.linearRampToValueAtTime(.3,a+.01),n.gain.linearRampToValueAtTime(.2,a+.05),n.gain.setValueAtTime(.2,a+t-.05),n.gain.linearRampToValueAtTime(0,a+t),s.connect(n),n.connect(this.masterGain),s.start(a),s.stop(a+t)}playChord(e,t,i="sine"){e.forEach(e=>this.playTone(e,t,i))}playNoise(e,t=500){if(!this.context||!this.masterGain||this.muted)return;const i=this.context.sampleRate*e,s=this.context.createBuffer(1,i,this.context.sampleRate),n=s.getChannelData(0);for(let l=0;l<i;l++)n[l]=2*Math.random()-1;const a=this.context.createBufferSource();a.buffer=s;const r=this.context.createBiquadFilter();r.type="lowpass",r.frequency.value=t;const o=this.context.createGain(),c=this.context.currentTime;o.gain.setValueAtTime(.1,c),o.gain.exponentialRampToValueAtTime(.01,c+e),a.connect(r),r.connect(o),o.connect(this.masterGain),a.start(c),a.stop(c+e)}}class V{constructor(e){t(this,"audioEngine"),this.audioEngine=e}playPiecePlaced(){this.audioEngine.playNoise(.08,300)}playLineClear(){let e=0;[{freq:500,duration:.06},{freq:600,duration:.05},{freq:750,duration:.07},{freq:900,duration:.08},{freq:700,duration:.06},{freq:550,duration:.05}].forEach(({freq:t,duration:i})=>{setTimeout(()=>{this.audioEngine.playTone(t,i,"triangle")},e),e+=1e3*i*.7})}playCascade(e){const t=500,i=100*e,s=[t+i,t+i+200,t+i+400];this.audioEngine.playChord(s,.15,"triangle"),setTimeout(()=>{this.audioEngine.playTone(t+i+600,.1,"sine")},80)}playGameOver(){let e=0;[500,400,300,250].forEach(t=>{setTimeout(()=>{this.audioEngine.playTone(t,.2,"triangle")},e),e+=150})}playSuccess(){this.audioEngine.playChord([523,659,784],.3,"sine")}playInvalid(){this.audioEngine.playTone(150,.1,"square")}}class X{constructor(e,i,s){t(this,"board"),t(this,"scoreManager"),t(this,"cascadeEngine"),t(this,"pieceManager"),t(this,"boardRenderer"),t(this,"panelRenderer"),t(this,"effectsRenderer"),t(this,"hudRenderer"),t(this,"animationLoop"),t(this,"inputManager"),t(this,"gameState",Y.LOADING),t(this,"effects",[]),t(this,"animatingCascade",!1),t(this,"clearAnimationManager"),t(this,"gameStorage"),t(this,"autoSaveTimeout",null),t(this,"storageAvailable",!1),t(this,"audioEngine"),t(this,"soundEffects"),this.board=new g,this.scoreManager=new m,this.cascadeEngine=new f,this.pieceManager=new I,this.boardRenderer=new A(e);const n=this.boardRenderer.getCellSize();this.panelRenderer=new R(i,n),this.effectsRenderer=new z(s,n),this.hudRenderer=new B,this.clearAnimationManager=new H,this.setupEffectsCanvas(s),this.inputManager=new N(e,n),this.inputManager.setPanelCanvas(i),this.inputManager.setCallbacks(this.handlePiecePlaced.bind(this),this.handlePieceSelected.bind(this)),i.addEventListener("mousedown",this.handlePanelClick.bind(this)),i.addEventListener("touchstart",this.handlePanelTouch.bind(this),{passive:!1}),document.addEventListener("touchmove",this.handleGlobalTouchMove.bind(this),{passive:!1}),document.addEventListener("touchend",this.handleGlobalTouchEnd.bind(this),{passive:!1}),document.addEventListener("touchcancel",this.handleGlobalTouchEnd.bind(this),{passive:!1}),this.animationLoop=new G(this.update.bind(this)),this.gameStorage=new _,this.audioEngine=new F,this.audioEngine.init(),this.soundEffects=new V(this.audioEngine),document.addEventListener("click",()=>{this.audioEngine.resume()},{once:!0}),this.setupAudioTestButtons(),this.init()}setupEffectsCanvas(e){const t=document.querySelector(".game-area");if(!t)return;const i=t.getBoundingClientRect();e.width=i.width,e.height=i.height,e.style.width=`${i.width}px`,e.style.height=`${i.height}px`}async init(){try{await this.gameStorage.init(),this.storageAvailable=!0}catch(i){this.storageAvailable=!1}const e=localStorage.getItem("purrfectBlocksHighScore"),t=e?parseInt(e):0;if(this.hudRenderer.updateHighScore(t),this.storageAvailable)try{const e=await this.gameStorage.loadGame();e&&this.restoreGameState(e)}catch(i){}this.gameState=Y.PLAYING;this.pieceManager.getAvailablePieces();this.animationLoop.start(),this.render()}setupAudioTestButtons(){[{id:"test-piece-placed",handler:()=>this.soundEffects.playPiecePlaced()},{id:"test-line-clear",handler:()=>this.soundEffects.playLineClear()},{id:"test-cascade-2x",handler:()=>this.soundEffects.playCascade(2)},{id:"test-cascade-3x",handler:()=>this.soundEffects.playCascade(3)},{id:"test-cascade-4x",handler:()=>this.soundEffects.playCascade(4)},{id:"test-game-over",handler:()=>this.soundEffects.playGameOver()},{id:"test-success",handler:()=>this.soundEffects.playSuccess()},{id:"test-invalid",handler:()=>this.soundEffects.playInvalid()}].forEach(({id:e,handler:t})=>{const i=document.getElementById(e);i&&i.addEventListener("click",t)})}update(e){if(this.gameState!==Y.PLAYING)return;const t=this.inputManager.getDragHandler();if(t.isDragging()){const e=t.getDragState();t.updateDrag(e.currentX,e.currentY,this.board,this.boardRenderer.getCellSize())}this.updateEffects(e),this.render()}render(){this.renderBoardWithAnimations(),this.panelRenderer.render(this.pieceManager.getAvailablePieces(),this.pieceManager.getSelectedIndex()),this.effectsRenderer.render(this.effects),this.renderDraggedPiece(),this.hudRenderer.updateScore(this.scoreManager.getScore()),this.hudRenderer.updateCombo(this.scoreManager.getComboMultiplier())}renderBoardWithAnimations(){const e=this.board.getCells(),t=this.boardRenderer.ctx;this.boardRenderer.getCellSize(),D(t),this.boardRenderer.drawGrid();for(let i=0;i<e.length;i++)for(let t=0;t<e[i].length;t++){const s=e[i][t];if(s.occupied&&s.color){const e=this.clearAnimationManager.getBlockProgress(i,t);null!==e&&e<1?this.boardRenderer.drawCellWithAnimation(i,t,s.color,e):null===e&&this.boardRenderer.drawCell(i,t,s.color)}}}renderDraggedPiece(){const e=this.inputManager.getDragHandler().getDragState();if(e.isDragging&&e.piece){const t=this.effectsRenderer.ctx,i=this.boardRenderer.getCellSize();t.clearRect(0,0,t.canvas.width,t.canvas.height);const s=document.querySelector(".game-area"),n=this.boardRenderer.ctx.canvas;if(s&&n){const a=s.getBoundingClientRect(),r=n.getBoundingClientRect(),o=r.left-a.left,c=r.top-a.top;t.save(),t.translate(o,c),O.render(t,e.piece.shape,e.gridRow,e.gridCol,i,e.isValid),t.restore(),T.renderPiece(t,e.piece,e.currentX+o-i,e.currentY+c-i,i,.8)}}}handlePanelClick(e){if(this.gameState!==Y.PLAYING)return;const t=e.currentTarget.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top,n=this.panelRenderer.getSlotIndexFromCoordinates(i,s);if(n>=0){const t=this.pieceManager.selectPiece(n);t&&this.inputManager.startDragFromPanel(t,e)}}handlePanelTouch(e){if(this.gameState!==Y.PLAYING)return;if(e.preventDefault(),0===e.touches.length)return;const t=e.touches[0],i=e.currentTarget.getBoundingClientRect(),s=t.clientX-i.left,n=t.clientY-i.top,a=this.panelRenderer.getSlotIndexFromCoordinates(s,n);if(a>=0){const e=this.pieceManager.selectPiece(a);if(e){const i={clientX:t.clientX,clientY:t.clientY};this.inputManager.startDragFromPanel(e,i)}}}handleGlobalTouchMove(e){const t=this.inputManager.getDragHandler();if(!t.isDragging())return;if(e.preventDefault(),0===e.touches.length)return;const i=e.touches[0],s=this.boardRenderer.getCanvas().getBoundingClientRect(),n=i.clientX-s.left,a=i.clientY-s.top;t.dragState.currentX=n,t.dragState.currentY=a}handleGlobalTouchEnd(e){const t=this.inputManager.getDragHandler();if(!t.isDragging())return;e.preventDefault();const i=t.endDrag();i&&this.handlePiecePlaced(i.piece,i.row,i.col)}handlePieceSelected(e){this.pieceManager.selectPiece(e)}handlePiecePlaced(e,t,i){if(this.animatingCascade)return;this.soundEffects.playPiecePlaced(),this.board.placePiece(e.shape,t,i,e.color,e.id);const s=this.pieceManager.getSelectedIndex();s>=0&&this.pieceManager.consumePiece(s),this.processCascadeWithAnimation()}async processCascadeWithAnimation(){this.animatingCascade=!0,this.cascadeEngine.reset(),await this.delay(200);let e=0;for(;;){const t=this.cascadeEngine.detectLines(this.board);if(!t)break;this.soundEffects.playLineClear(),this.clearAnimationManager.scheduleClearing(t.rows,t.cols,this.board);this.clearAnimationManager.getTotalDuration(),Date.now();for(;this.clearAnimationManager.isAnimating();)await this.delay(16);e+=this.cascadeEngine.clearLines(this.board,t),this.clearAnimationManager.clear(),await this.delay(100)}if(e>0){const t=this.cascadeEngine.getCascadeLevel(),i=this.scoreManager.addScore(e,t);t>1&&(this.soundEffects.playCascade(t),this.hudRenderer.showMessage(`${t}x CASCADE! +${i}`))}else this.scoreManager.resetCombo();this.animatingCascade=!1,this.scheduleAutoSave(),this.pieceManager.hasPlayablePieces(this.board)||this.gameOver()}updateEffects(e){this.effects=this.effects.filter(t=>(t.progress+=e/1e3,t.progress<1))}delay(e){return new Promise(t=>setTimeout(t,e))}async gameOver(){this.gameState=Y.GAME_OVER,this.animationLoop.stop(),this.soundEffects.playGameOver();const e=this.scoreManager.getScore(),t=localStorage.getItem("purrfectBlocksHighScore"),i=t?parseInt(t):0,s=Math.max(e,i);s>i&&(localStorage.setItem("purrfectBlocksHighScore",s.toString()),this.hudRenderer.updateHighScore(s)),await this.delay(200),this.showGameOverModal(e,s)}showGameOverModal(e,t){const i=document.getElementById("game-over-modal"),s=document.getElementById("final-score"),n=document.getElementById("high-score"),a=document.getElementById("play-again-btn"),r=document.getElementById("modal-close-btn");if(i&&s&&n&&a&&r){s.textContent=e.toString(),n.textContent=t.toString(),i.classList.remove("hidden");const o=()=>{i.classList.add("hidden"),this.restart()};a.onclick=o,r.onclick=o}}scheduleAutoSave(){null!==this.autoSaveTimeout&&clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=window.setTimeout(()=>{this.saveGame(),this.autoSaveTimeout=null},300)}async saveGame(){if(this.storageAvailable)try{const e={board:this.board.getCells().map(e=>e.map(e=>e.occupied?1:0)),score:this.scoreManager.getScore(),combo:this.scoreManager.getComboMultiplier(),availablePieces:this.pieceManager.getAvailablePieces().map(e=>({shape:e.shape,color:e.color,id:e.id})),timestamp:Date.now()};await this.gameStorage.saveGame(e)}catch(e){this.storageAvailable=!1}}restoreGameState(e){try{const t=e.board,i=this.board.getCells();for(let e=0;e<t.length&&e<i.length;e++)for(let s=0;s<t[e].length&&s<i[e].length;s++)1===t[e][s]&&this.board.placePiece([[!0]],e,s,"#D84315",`restored-${e}-${s}`);this.scoreManager.score=e.score,this.scoreManager.comboMultiplier=e.combo}catch(t){}}restart(){this.board.clear(),this.scoreManager.reset(),this.cascadeEngine.reset(),this.pieceManager.reset(),this.effects=[],this.animatingCascade=!1,this.gameState=Y.PLAYING,this.gameStorage.deleteSave().catch(e=>{}),this.animationLoop.start(),this.render()}getAudioEngine(){return this.audioEngine}pause(){this.gameState===Y.PLAYING&&(this.gameState=Y.PAUSED,this.animationLoop.stop())}resume(){this.gameState===Y.PAUSED&&(this.gameState=Y.PLAYING,this.animationLoop.start())}isPaused(){return this.gameState===Y.PAUSED}}const W="playerSettings";class ${constructor(){t(this,"db",null)}async init(){return new Promise((e,t)=>{const i=indexedDB.open("PurrfectBlocksDB",2);let s=!1;i.onerror=()=>{s||(s=!0,t(new Error("Failed to open IndexedDB")))},i.onsuccess=()=>{s||(s=!0,this.db=i.result,e())},i.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(W)||t.createObjectStore(W,{keyPath:"id"})},i.onblocked=()=>{},setTimeout(()=>{s||(s=!0,t(new Error("PlayerSettings DB initialization timeout")))},1e4)})}async getPlayerSettings(e="default"){return this.db||await this.init(),this.db&&this.db.objectStoreNames.contains(W)?new Promise((t,i)=>{try{const s=this.db.transaction([W],"readonly"),n=s.objectStore(W).get(e);n.onsuccess=()=>{t(n.result||null)},n.onerror=()=>{i(new Error("Failed to get player settings"))}}catch(s){t(null)}}):null}async savePlayerSettings(e){if(this.db||await this.init(),this.db&&this.db.objectStoreNames.contains(W))return new Promise((t,i)=>{try{const s=this.db.transaction([W],"readwrite"),n=s.objectStore(W).put(e);n.onsuccess=()=>{t()},n.onerror=()=>{i(new Error("Failed to save player settings"))}}catch(s){i(s)}})}}const j=["Meow","Purrr","Mrrrow","Nya","Mew","Purr-fect","Meowdy","Paw-some","Fur-tastic","Whisker-ific"],q=["üêæ","üò∫","üò∏","üòª","üê±","üéÄ","üß∂","üêü"];function U(e){return`${j[Math.floor(Math.random()*j.length)]}, ${e}! ${function(){const e=Math.floor(3*Math.random())+1,t=[];for(let i=0;i<e;i++){const e=q[Math.floor(Math.random()*q.length)];t.push(e)}return t.join(" ")}()}`}let Z,K;function Q(){const e=document.getElementById("player-name-input"),t=document.getElementById("player-uuid"),i=document.getElementById("volume-slider"),s=document.getElementById("volume-value"),n=document.getElementById("mute-toggle");if(e&&(e.value=K.name),t&&(t.textContent=K.uuid),i&&s){const e=K.volume||70;i.value=e.toString(),s.textContent=`${e}%`}if(n){const e=K.muted||!1;n.textContent=e?"üîá":"üîä"}}function J(){const e=document.getElementById("player-greeting");e&&(e.textContent=U(K.name))}async function ee(){await async function(){Z=new $,await Z.init();let e=await Z.getPlayerSettings();e||(e={id:"default",name:"Player",uuid:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),volume:70,muted:!1},await Z.savePlayerSettings(e)),void 0===e.volume&&(e.volume=70),void 0===e.muted&&(e.muted=!1),K=e,Q(),J()}();const e=document.getElementById("board-canvas"),t=document.getElementById("panel-canvas"),i=document.getElementById("effects-canvas");if(!e||!t||!i)throw new Error("Canvas elements not found");const s=new X(e,t,i),n=document.getElementById("restart-btn");n&&n.addEventListener("click",()=>{s.restart()});const a=document.getElementById("fullscreen-btn"),r=document.getElementById("exit-fullscreen-btn");a&&a.addEventListener("click",()=>{document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen()}),r&&r.addEventListener("click",()=>{document.exitFullscreen&&document.exitFullscreen()}),document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?(a&&(a.style.display="none"),r&&(r.style.display="inline-block")):(a&&(a.style.display="inline-block"),r&&(r.style.display="none"))});const o=document.getElementById("settings-btn-top"),c=document.getElementById("settings-modal"),l=document.getElementById("settings-close-btn"),h=document.getElementById("save-settings-btn"),d=()=>{Q();const e=K.volume||70,t=K.muted||!1;s.getAudioEngine().setVolume(e/100),s.getAudioEngine().setMuted(t),c&&c.classList.add("hidden")};o&&c&&o.addEventListener("click",()=>{c.classList.remove("hidden"),Q()}),l&&c&&(l.addEventListener("click",()=>{d()}),c.addEventListener("click",e=>{e.target===c&&d()})),h&&h.addEventListener("click",async()=>{const e=document.getElementById("player-name-input"),t=document.getElementById("volume-slider"),i=document.getElementById("mute-toggle"),s=e.value.trim()||"Player",n=t?parseInt(t.value):70,a="üîá"===(null==i?void 0:i.textContent);K.name=s,K.volume=n,K.muted=a,await Z.savePlayerSettings(K),J(),c&&c.classList.add("hidden")});const u=document.getElementById("volume-slider"),g=document.getElementById("volume-value");if(u&&g){const e=K.volume||70;u.value=e.toString(),g.textContent=`${e}%`,s.getAudioEngine().setVolume(e/100),u.addEventListener("input",()=>{const e=parseInt(u.value);g.textContent=`${e}%`,s.getAudioEngine().setVolume(e/100)})}const m=document.getElementById("mute-toggle");if(m){const e=K.muted||!1;m.textContent=e?"üîá":"üîä",s.getAudioEngine().setMuted(e),m.addEventListener("click",()=>{const e=!("üîá"===m.textContent);s.getAudioEngine().setMuted(e),m.textContent=e?"üîá":"üîä"})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",ee):ee();
