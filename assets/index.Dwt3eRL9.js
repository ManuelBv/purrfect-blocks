var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const i=8,s=8,a=.45,n=.5,r=768,o=3,c=100,l=.5;function h(){const e=function(){const e=window.innerWidth<r?n:a,t=window.innerHeight*e;return Math.floor(t/i)}();return{width:s*e,height:i*e,cellSize:e}}class d{constructor(){t(this,"_occupied",!1),t(this,"_color",null),t(this,"_pieceId",null)}get occupied(){return this._occupied}get color(){return this._color}get pieceId(){return this._pieceId}fill(e,t){this._occupied=!0,this._color=e,this._pieceId=t}clear(){this._occupied=!1,this._color=null,this._pieceId=null}isEmpty(){return!this._occupied}toData(){return{occupied:this._occupied,color:this._color,pieceId:this._pieceId}}static fromData(e){const t=new d;return e.occupied&&e.color&&e.pieceId&&t.fill(e.color,e.pieceId),t}}class u{static isValidPosition(e,t,i,s){return e>=0&&e<i&&t>=0&&t<s}static canPlacePiece(e,t,i,s){const a=e.length,n=e[0].length;for(let r=0;r<t.length;r++)for(let o=0;o<t[r].length;o++)if(t[r][o]){const t=i+r,c=s+o;if(!this.isValidPosition(t,c,a,n))return!1;if(e[t][c].occupied)return!1}return!0}static getOccupiedPositions(e,t,i){const s=[];for(let a=0;a<e.length;a++)for(let n=0;n<e[a].length;n++)e[a][n]&&s.push({row:t+a,col:i+n});return s}}class g{constructor(){t(this,"cells"),t(this,"rows",i),t(this,"cols",s),this.cells=this.initializeGrid()}initializeGrid(){const e=[];for(let t=0;t<this.rows;t++){e[t]=[];for(let i=0;i<this.cols;i++)e[t][i]=new d}return e}getCells(){return this.cells}getCell(e,t){return e<0||e>=this.rows||t<0||t>=this.cols?null:this.cells[e][t]}canPlacePiece(e,t,i){return u.canPlacePiece(this.cells,e,t,i)}placePiece(e,t,i,s,a){const n=u.getOccupiedPositions(e,t,i);for(const r of n)this.cells[r.row][r.col].fill(s,a)}getCompleteLines(){const e=[],t=[];for(let i=0;i<this.rows;i++)this.isRowComplete(i)&&e.push(i);for(let i=0;i<this.cols;i++)this.isColumnComplete(i)&&t.push(i);return{rows:e,cols:t}}isRowComplete(e){for(let t=0;t<this.cols;t++)if(this.cells[e][t].isEmpty())return!1;return!0}isColumnComplete(e){for(let t=0;t<this.rows;t++)if(this.cells[t][e].isEmpty())return!1;return!0}clearLines(e,t){for(const i of e)for(let e=0;e<this.cols;e++)this.cells[i][e].occupied&&this.cells[i][e].clear();for(const i of t)for(let e=0;e<this.rows;e++)this.cells[e][i].occupied&&this.cells[e][i].clear();return e.length+t.length}applyGravity(){let e=!1;for(let t=0;t<this.cols;t++){let i=this.rows-1;for(let s=this.rows-1;s>=0;s--)if(this.cells[s][t].occupied){if(s!==i){const a=this.cells[s][t].toData();this.cells[i][t].fill(a.color,a.pieceId),this.cells[s][t].clear(),e=!0}i--}}return e}isFull(){for(let e=0;e<this.cols;e++)if(this.cells[0][e].occupied)return!0;return!1}serialize(){return this.cells.map(e=>e.map(e=>e.toData()))}static deserialize(e){const t=new g;for(let i=0;i<t.rows;i++)for(let s=0;s<t.cols;s++)t.cells[i][s]=d.fromData(e[i][s]);return t}explode3x3(e,t){let i=0;for(let s=e-1;s<=e+1;s++)for(let e=t-1;e<=t+1;e++)s>=0&&s<this.rows&&e>=0&&e<this.cols&&this.cells[s][e].occupied&&(this.cells[s][e].clear(),i++);return i}clear(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.cols;t++)this.cells[e][t].clear()}}class m{constructor(){t(this,"score",0),t(this,"comboMultiplier",1),t(this,"totalLinesCleared",0)}addScore(e,t){const i=e*c,s=1+t*l,a=Math.floor(i*s);return this.score+=a,this.comboMultiplier=s,this.totalLinesCleared+=e,a}getScore(){return this.score}getComboMultiplier(){return this.comboMultiplier}getTotalLinesCleared(){return this.totalLinesCleared}reset(){this.score=0,this.comboMultiplier=1,this.totalLinesCleared=0}resetCombo(){this.comboMultiplier=1}addExplosionScore(e){const t=50*e;return this.score+=t,t}}class p{constructor(){t(this,"cascadeLevel",0)}detectLines(e){const t=e.getCompleteLines();return 0===t.rows.length+t.cols.length?null:t}clearLines(e,t){const i=t.rows.length+t.cols.length;return e.clearLines(t.rows,t.cols),this.cascadeLevel++,i}processCascade(e){let t=0;for(this.cascadeLevel=0;;){const i=e.getCompleteLines(),s=i.rows.length+i.cols.length;if(0===s)break;e.clearLines(i.rows,i.cols),t+=s,this.cascadeLevel++}return{cascadeLevel:this.cascadeLevel,totalLinesCleared:t,scoreAdded:0}}getCascadeLevel(){return this.cascadeLevel}reset(){this.cascadeLevel=0}}class f{constructor(e,i){t(this,"id"),t(this,"definition"),this.id=i||this.generateId(),this.definition=e}generateId(){return`piece_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}get shape(){return this.definition.shape}get color(){return this.definition.color}get width(){return this.definition.shape[0].length}get height(){return this.definition.shape.length}toData(){return{id:this.id,definition:this.definition}}static fromData(e){return new f(e.definition,e.id)}}var S=(e=>(e.TETROMINO_L="TETROMINO_L",e.TETROMINO_I="TETROMINO_I",e.TETROMINO_F="TETROMINO_F",e.TETROMINO_T="TETROMINO_T",e.SQUARE="SQUARE",e.BOMB="BOMB",e))(S||{});class b extends f{constructor(){super({type:S.BOMB,shape:[[!0]],color:"#8B4513",rotation:0,size:1}),t(this,"isBomb",!0)}getExplosionCells(e,t){const i=[];for(let s=e-1;s<=e+1;s++)for(let e=t-1;e<=t+1;e++)i.push({row:s,col:e});return i}}const y=["#E53935","#1E88E5","#43A047","#FDD835","#6D4C41"],v={0:[[!0,!1],[!0,!1],[!0,!0]],90:[[!0,!0,!0],[!0,!1,!1]],180:[[!0,!0],[!1,!0],[!1,!0]],270:[[!1,!1,!0],[!0,!0,!0]]},w={0:[[!0],[!0],[!0],[!0]],90:[[!0,!0,!0,!0]],180:[[!0],[!0],[!0],[!0]],270:[[!0,!0,!0,!0]]},E={0:[[!1,!0,!0],[!0,!0,!1]],90:[[!0,!1],[!0,!0],[!1,!0]],180:[[!1,!0,!0],[!0,!0,!1]],270:[[!0,!1],[!0,!0],[!1,!0]]},x={0:[[!0,!0,!0],[!1,!0,!1]],90:[[!1,!0],[!0,!0],[!1,!0]],180:[[!1,!0,!1],[!0,!0,!0]],270:[[!0,!1],[!0,!0],[!0,!1]]};function P(e){return Array(e).fill(null).map(()=>Array(e).fill(!0))}const M=[],C=[0,90,180,270];C.forEach((e,t)=>{M.push({type:"TETROMINO_L",shape:v[e],color:y[0],rotation:e,size:0})}),C.forEach((e,t)=>{M.push({type:"TETROMINO_I",shape:w[e],color:y[1],rotation:e,size:0})}),C.forEach((e,t)=>{M.push({type:"TETROMINO_F",shape:E[e],color:y[2],rotation:e,size:0})}),C.forEach((e,t)=>{M.push({type:"TETROMINO_T",shape:x[e],color:y[3],rotation:e,size:0})});for(let ne=1;ne<=3;ne++)M.push({type:"SQUARE",shape:P(ne),color:y[4],rotation:0,size:ne});class T{createRandomPiece(){const e=Math.floor(Math.random()*M.length);return new f(M[e])}createPieceByIndex(e){if(e<0||e>=M.length)throw new Error(`Invalid piece index: ${e}`);return new f(M[e])}createBombPiece(){return new b}createMultiplePieces(e,t=1){const i=[];for(let s=0;s<e;s++)i.push(this.createRandomPiece());if(t>=1.5&&i.length>0){i[Math.floor(Math.random()*i.length)]=this.createBombPiece()}return i}}class I{constructor(){t(this,"factory"),t(this,"availablePieces"),t(this,"selectedIndex",-1),t(this,"turnsSinceLastBomb",0),t(this,"turnsUntilNextBomb",this.randomTurnsUntilBomb()),this.factory=new T,this.availablePieces=this.factory.createMultiplePieces(o)}randomTurnsUntilBomb(){return Math.floor(3*Math.random())+3}getAvailablePieces(){return this.availablePieces}selectPiece(e){return e<0||e>=this.availablePieces.length?null:(this.selectedIndex=e,this.availablePieces[e])}consumePiece(e,t=1){if(e<0||e>=this.availablePieces.length)return null;const i=this.availablePieces[e];this.turnsSinceLastBomb++;return this.turnsSinceLastBomb>=this.turnsUntilNextBomb?(this.turnsSinceLastBomb=0,this.turnsUntilNextBomb=this.randomTurnsUntilBomb(),this.availablePieces[e]=this.factory.createBombPiece()):this.availablePieces[e]=this.factory.createRandomPiece(),this.selectedIndex=-1,i}getSelectedIndex(){return this.selectedIndex}clearSelection(){this.selectedIndex=-1}hasAvailablePieces(){return this.availablePieces.length>0}hasPlayablePieces(e){for(const t of this.availablePieces)for(let i=0;i<18;i++)for(let s=0;s<12;s++)if(e.canPlacePiece(t.shape,i,s))return!0;return!1}reset(){this.availablePieces=this.factory.createMultiplePieces(o),this.selectedIndex=-1,this.turnsSinceLastBomb=0,this.turnsUntilNextBomb=this.randomTurnsUntilBomb()}}function L(e){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle="#FFF8E1",e.fillRect(0,0,e.canvas.width,e.canvas.height)}class B{constructor(e){t(this,"canvas"),t(this,"ctx"),t(this,"cellSize"),this.canvas=e;const i=e.getContext("2d");if(!i)throw new Error("Could not get 2d context");this.ctx=i;const s=h();this.cellSize=s.cellSize,e.width=s.width,e.height=s.height}render(e){this.clear(),this.drawGrid(),this.drawCells(e)}clear(){L(this.ctx)}drawGrid(){this.ctx.strokeStyle="rgba(141, 110, 99, 0.3)",this.ctx.lineWidth=.5;for(let e=0;e<=18;e++){const t=e*this.cellSize;this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(12*this.cellSize,t),this.ctx.stroke()}for(let e=0;e<=12;e++){const t=e*this.cellSize;this.ctx.beginPath(),this.ctx.moveTo(t,0),this.ctx.lineTo(t,18*this.cellSize),this.ctx.stroke()}}drawCells(e){for(let t=0;t<e.length;t++)for(let i=0;i<e[t].length;i++){const s=e[t][i];s.occupied&&s.color&&this.drawCell(t,i,s.color)}}drawCell(e,t,i){const s=t*this.cellSize,a=e*this.cellSize;this.ctx.fillStyle=i,this.ctx.fillRect(s+1,a+1,this.cellSize-2,this.cellSize-2)}drawCellWithAnimation(e,t,i,s){const a=t*this.cellSize,n=e*this.cellSize,r=this.cellSize-2;this.ctx.save();const o=s*(.6*this.cellSize),c=Math.max(0,1-1.2*s),l=Math.max(0,1-.8*s),h=s*Math.PI*.5;this.ctx.globalAlpha=c;const d=r/2,u=a+this.cellSize/2,g=n+this.cellSize/2;[{offsetX:-1,offsetY:-1},{offsetX:1,offsetY:-1},{offsetX:-1,offsetY:1},{offsetX:1,offsetY:1}].forEach(({offsetX:e,offsetY:t})=>{this.ctx.save();const s=u+e*o,a=g+t*o;this.ctx.translate(s,a),this.ctx.rotate(h*e*t),this.ctx.fillStyle=i,this.ctx.fillRect(-d*l/2,-d*l/2,d*l,d*l),this.ctx.restore()}),this.ctx.restore()}getCellSize(){return this.cellSize}getCanvas(){return this.canvas}}class D{static renderPiece(e,t,i,s,a,n=1){e.save(),e.globalAlpha=n;const r=t.shape,o=t.color,c=t.definition.type===S.BOMB;for(let l=0;l<r.length;l++)for(let t=0;t<r[l].length;t++)if(r[l][t]){const n=i+t*a,r=s+l*a;c?this.drawYarnBall(e,n+a/2,r+a/2,.4*a):(e.fillStyle=o,e.fillRect(n+1,r+1,a-2,a-2),e.strokeStyle="rgba(0, 0, 0, 0.2)",e.lineWidth=1,e.strokeRect(n+1,r+1,a-2,a-2))}e.restore()}static drawYarnBall(e,t,i,s){e.save(),e.fillStyle="#D2691E",e.beginPath(),e.arc(t,i,s,0,2*Math.PI),e.fill(),e.strokeStyle="#A0522D",e.lineWidth=.15*s,e.beginPath(),e.moveTo(t-.6*s,i-.6*s),e.lineTo(t+.6*s,i+.6*s),e.stroke(),e.beginPath(),e.moveTo(t+.6*s,i-.6*s),e.lineTo(t-.6*s,i+.6*s),e.stroke(),e.beginPath(),e.moveTo(t-.7*s,i),e.lineTo(t+.7*s,i),e.stroke(),e.fillStyle="rgba(255, 255, 255, 0.3)",e.beginPath(),e.arc(t-.3*s,i-.3*s,.3*s,0,2*Math.PI),e.fill(),e.restore()}static getPieceDimensions(e,t){return{width:e[0].length*t,height:e.length*t}}static renderPieceCentered(e,t,i,s,a,n=1){const r=this.getPieceDimensions(t.shape,a),o=i-r.width/2,c=s-r.height/2;this.renderPiece(e,t,o,c,a,n)}}class A{constructor(e,i){t(this,"ctx"),t(this,"cellSize"),t(this,"SLOTS",3),t(this,"pieceSpacing"),t(this,"MAX_PIECE_SIZE",4),t(this,"canvasWidth"),t(this,"canvasHeight");const s=e.getContext("2d");if(!s)throw new Error("Could not get 2d context for panel");this.ctx=s;const a=window.innerWidth,n=a<768;a<=380?(this.pieceSpacing=2,this.cellSize=.75*i):n?(this.pieceSpacing=3,this.cellSize=.85*i):(this.pieceSpacing=28,this.cellSize=i);const r=this.MAX_PIECE_SIZE*this.cellSize;this.canvasWidth=r*this.SLOTS+this.pieceSpacing*(this.SLOTS-1),this.canvasHeight=r,e.width=this.canvasWidth,e.height=this.canvasHeight}render(e,t){this.clear(),this.drawPieces(e)}clear(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}drawPieces(e){const t=this.MAX_PIECE_SIZE*this.cellSize;for(let i=0;i<Math.min(e.length,this.SLOTS);i++){const s=e[i],a=t/2+i*(t+this.pieceSpacing),n=this.canvasHeight/2;D.renderPieceCentered(this.ctx,s,a,n,this.cellSize)}}getSlotIndexFromCoordinates(e,t){const i=this.MAX_PIECE_SIZE*this.cellSize;if(t<0||t>this.canvasHeight)return-1;for(let s=0;s<this.SLOTS;s++){const t=s*(i+this.pieceSpacing);if(e>=t&&e<t+i)return s}return-1}getCellSize(){return this.cellSize}}class R{constructor(e,i){t(this,"ctx"),t(this,"cellSize");const s=e.getContext("2d");if(!s)throw new Error("Could not get 2d context for effects");this.ctx=s,this.cellSize=i}render(e,t=[]){this.clear();for(const i of e)switch(i.type){case"CLEAR_LINE":this.renderClearEffect(i);break;case"GLOW":this.renderGlowEffect(i);break;case"FALL":this.renderFallEffect(i)}this.renderParticles(t)}clear(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}renderClearEffect(e){const{row:t,col:i}=e.position,s=i*this.cellSize,a=t*this.cellSize;if(this.ctx.save(),this.ctx.globalAlpha=1-e.progress,this.ctx.fillStyle="#FFD700",this.ctx.fillRect(s,a,this.cellSize,this.cellSize),e.progress<.5){this.ctx.globalAlpha=.8,this.ctx.strokeStyle=e.color,this.ctx.lineWidth=3;const t=this.cellSize*(1+2*e.progress),i=(t-this.cellSize)/2;this.ctx.strokeRect(s-i,a-i,t,t)}this.ctx.restore()}renderGlowEffect(e){const{row:t,col:i}=e.position,s=i*this.cellSize+this.cellSize/2,a=t*this.cellSize+this.cellSize/2;this.ctx.save();const n=.5+.3*Math.sin(e.progress*Math.PI*4);this.ctx.globalAlpha=n,this.ctx.shadowBlur=20,this.ctx.shadowColor=e.color,this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(s,a,this.cellSize/3,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()}renderFallEffect(e){const{row:t,col:i}=e.position,s=i*this.cellSize,a=t*this.cellSize;this.ctx.save(),this.ctx.globalAlpha=.3*(1-e.progress),this.ctx.fillStyle=e.color,this.ctx.fillRect(s,a-this.cellSize*e.progress,this.cellSize,this.cellSize*e.progress),this.ctx.restore()}renderParticles(e){this.ctx.save();for(const t of e)this.ctx.globalAlpha=t.life,this.ctx.fillStyle=t.color,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.size,0,2*Math.PI),this.ctx.fill(),t.life>.5&&(this.ctx.globalAlpha=.5*t.life,this.ctx.shadowBlur=4,this.ctx.shadowColor=t.color,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,1.5*t.size,0,2*Math.PI),this.ctx.fill(),this.ctx.shadowBlur=0);this.ctx.restore()}updateSize(e){this.cellSize=e}}class z{updateScore(e){const t=document.getElementById("score");t&&(t.textContent=e.toString())}updateCombo(e){const t=document.getElementById("combo");t&&(t.textContent=`${e.toFixed(1)}x`,e>1?t.classList.add("combo-active"):t.classList.remove("combo-active"))}updateHighScore(e){const t=document.getElementById("high-score-display");t&&(t.textContent=e.toString())}showMessage(e,t=2e3){const i=document.createElement("div");i.className="game-message",i.textContent=e,document.body.appendChild(i),setTimeout(()=>{i.remove()},t)}}class k{constructor(e){t(this,"lastTime",0),t(this,"animationId",null),t(this,"callback"),t(this,"isRunning",!1),t(this,"loop",()=>{if(!this.isRunning)return;const e=performance.now(),t=e-this.lastTime;this.lastTime=e,this.callback(t),this.animationId=requestAnimationFrame(this.loop)}),this.callback=e}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.loop())}stop(){this.isRunning=!1,null!==this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}isActive(){return this.isRunning}}class G{constructor(){t(this,"dragState",{piece:null,startX:0,startY:0,currentX:0,currentY:0,isDragging:!1,isValid:!1,gridRow:0,gridCol:0,isTouch:!1})}startDrag(e,t,i,s=!1){this.dragState={piece:e,startX:t,startY:i,currentX:t,currentY:i,isDragging:!0,isValid:!1,gridRow:0,gridCol:0,isTouch:s}}updateDrag(e,t,i,s){if(!this.dragState.isDragging||!this.dragState.piece)return;let a=e,n=t;if(this.dragState.isTouch&&this.dragState.piece){a=e-.5*(this.dragState.piece.shape[0].length*s),n=t-.5*(this.dragState.piece.shape.length*s),this.dragState.currentX=a,this.dragState.currentY=n}else this.dragState.currentX=e,this.dragState.currentY=t;if(this.dragState.isTouch&&this.dragState.piece){a=e-.5*(this.dragState.piece.shape[0].length*s),n=t-.5*(this.dragState.piece.shape.length*s)}const r=this.screenToGrid(a,n,s);this.dragState.gridRow=r.row,this.dragState.gridCol=r.col,this.dragState.isValid=i.canPlacePiece(this.dragState.piece.shape,r.row,r.col)}endDrag(){if(!this.dragState.isDragging||!this.dragState.piece||!this.dragState.isValid)return this.cancelDrag(),null;const e={piece:this.dragState.piece,row:this.dragState.gridRow,col:this.dragState.gridCol};return this.cancelDrag(),e}cancelDrag(){this.dragState={piece:null,startX:0,startY:0,currentX:0,currentY:0,isDragging:!1,isValid:!1,gridRow:0,gridCol:0,isTouch:!1}}getDragState(){return{...this.dragState}}isDragging(){return this.dragState.isDragging}screenToGrid(e,t,i){return{row:Math.floor(t/i),col:Math.floor(e/i)}}}class N{constructor(e,i){t(this,"dragHandler"),t(this,"cellSize"),t(this,"boardCanvas"),t(this,"panelCanvas",null),t(this,"onPiecePlaced",null),t(this,"onPieceSelected",null),this.boardCanvas=e,this.cellSize=i,this.dragHandler=new G,this.setupEventListeners()}setPanelCanvas(e){this.panelCanvas=e}setCallbacks(e,t){this.onPiecePlaced=e,this.onPieceSelected=t}setupEventListeners(){this.boardCanvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.boardCanvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.boardCanvas.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),this.boardCanvas.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this.boardCanvas.addEventListener("touchend",this.handleTouchEnd.bind(this))}startDragFromPanel(e,t,i=!1){const s=this.boardCanvas.getBoundingClientRect(),a=t.clientX-s.left,n=t.clientY-s.top;this.dragHandler.startDrag(e,a,n,i)}updateDrag(e){}handleMouseDown(e){}handleMouseMove(e){if(!this.dragHandler.isDragging())return;const t=this.boardCanvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;this.dragHandler.dragState.currentX=i,this.dragHandler.dragState.currentY=s}handleMouseUp(e){if(!this.dragHandler.isDragging())return;const t=this.dragHandler.endDrag();t&&this.onPiecePlaced&&this.onPiecePlaced(t.piece,t.row,t.col)}handleTouchStart(e){if(e.preventDefault(),0===e.touches.length)return;const t=e.touches[0],i=this.boardCanvas.getBoundingClientRect(),s=t.clientX-i.left,a=t.clientY-i.top;this.triggerHaptic("light"),this.dragHandler.dragState.currentX=s,this.dragHandler.dragState.currentY=a}handleTouchMove(e){if(e.preventDefault(),!this.dragHandler.isDragging()||0===e.touches.length)return;const t=e.touches[0],i=this.boardCanvas.getBoundingClientRect(),s=t.clientX-i.left,a=t.clientY-i.top;this.dragHandler.dragState.currentX=s,this.dragHandler.dragState.currentY=a}handleTouchEnd(e){if(!this.dragHandler.isDragging())return;this.triggerHaptic("medium");const t=this.dragHandler.endDrag();t&&this.onPiecePlaced&&this.onPiecePlaced(t.piece,t.row,t.col)}triggerHaptic(e){if("vibrate"in navigator){const t={light:10,medium:20,heavy:30};navigator.vibrate(t[e])}}getDragHandler(){return this.dragHandler}updateCellSize(e){this.cellSize=e}}class O{static lightenColor(e,t){const i=e.replace("#",""),s=parseInt(i.substring(0,2),16),a=parseInt(i.substring(2,4),16),n=parseInt(i.substring(4,6),16),r=Math.min(255,Math.floor(s+(255-s)*t)),o=Math.min(255,Math.floor(a+(255-a)*t)),c=Math.min(255,Math.floor(n+(255-n)*t));return`#${r.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}`}static detectCompletedLines(e,t,a,n){const r=[],o=[],c=[];for(let l=0;l<i;l++){c[l]=[];for(let t=0;t<s;t++)c[l][t]=e[l][t].occupied}for(let l=0;l<t.length;l++)for(let e=0;e<t[l].length;e++)if(t[l][e]){const t=a+l,r=n+e;t>=0&&t<i&&r>=0&&r<s&&(c[t][r]=!0)}for(let s=0;s<i;s++)c[s].every(e=>e)&&r.push(s);for(let i=0;i<s;i++)c.every(e=>e[i])&&o.push(i);return{rows:r,cols:o}}static render(e,t,a,n,r,o,c,l){if(!o)return;const h=c||"#CCCCCC",d=this.lightenColor(h,.5);e.save();let u=null;if(l&&(u=this.detectCompletedLines(l,t,a,n)),u&&(u.rows.length>0||u.cols.length>0)){e.strokeStyle=d,e.lineWidth=4,e.shadowBlur=15,e.shadowColor=d,e.globalAlpha=.8;for(const t of u.rows)e.strokeRect(0,t*r,s*r,r);for(const t of u.cols)e.strokeRect(t*r,0,r,i*r)}e.shadowBlur=20,e.shadowColor=d,e.globalAlpha=.5;for(let i=0;i<t.length;i++)for(let s=0;s<t[i].length;s++)if(t[i][s]){const t=(n+s)*r,o=(a+i)*r;e.strokeStyle=d,e.lineWidth=3,e.strokeRect(t+2,o+2,r-4,r-4),e.fillStyle=d,e.globalAlpha=.3,e.fillRect(t+3,o+3,r-6,r-6),e.globalAlpha=.5}e.restore()}}class F{constructor(e=!1){t(this,"particles",[]),t(this,"maxParticles"),t(this,"particlesPerBlock"),this.maxParticles=e?50:100,this.particlesPerBlock=e?2:4}spawnParticles(e,t,i,s){const a=e+i/2,n=t+i/2;for(let r=0;r<this.particlesPerBlock&&!(this.particles.length>=this.maxParticles);r++){const e=Math.random()*Math.PI*2,t=50+100*Math.random(),i={x:a,y:n,vx:Math.cos(e)*t,vy:Math.sin(e)*t,life:1,maxLife:300+200*Math.random(),color:this.randomizeColor(s),size:2+2*Math.random(),birthTime:Date.now()};this.particles.push(i)}}update(e){const t=Date.now();this.particles=this.particles.filter(i=>{const s=t-i.birthTime;if(s>=i.maxLife)return!1;i.life=1-s/i.maxLife;const a=e/1e3;return i.x+=i.vx*a,i.y+=i.vy*a,i.vy+=200*a,i.vx*=.98,i.vy*=.98,!0})}getParticles(){return this.particles}clear(){this.particles=[]}randomizeColor(e){const t=["#FFD700","#FFA500","#FFFF00","#FFE4B5","#FFDAB9"];return Math.random()<.7?t[Math.floor(Math.random()*t.length)]:e}getParticleCount(){return this.particles.length}}class _{constructor(e,i=!1){t(this,"animations",[]),t(this,"animationDuration",250),t(this,"staggerDelay",60),t(this,"particleSystem"),t(this,"cellSize"),this.cellSize=e,this.particleSystem=new F(i)}scheduleClearing(e,t,i){this.animations=[];const s=Date.now(),a=new Map;e.forEach(e=>{for(let t=0;t<12;t++){const s=`${e},${t}`,n=i.getCell(e,t);if(n&&n.occupied){const i=a.get(s),r=t*this.staggerDelay;(!i||r<i.delay)&&a.set(s,{row:e,col:t,delay:r,color:n.color||"#8B4513"})}}}),t.forEach(e=>{for(let t=0;t<18;t++){const s=`${t},${e}`,n=i.getCell(t,e);if(n&&n.occupied){const i=a.get(s),r=t*this.staggerDelay;(!i||r<i.delay)&&a.set(s,{row:t,col:e,delay:r,color:n.color||"#8B4513"})}}}),a.forEach(({row:e,col:t,delay:i,color:a})=>{this.animations.push({row:e,col:t,startTime:s+i,duration:this.animationDuration,color:a}),setTimeout(()=>{const i=t*this.cellSize,s=e*this.cellSize;this.particleSystem.spawnParticles(i,s,this.cellSize,a)},i)})}getBlockProgress(e,t){const i=this.animations.find(i=>i.row===e&&i.col===t);if(!i)return null;const s=Date.now()-i.startTime;return s<0?0:s>=i.duration?1:s/i.duration}isAnimating(){if(0===this.animations.length)return!1;const e=Date.now();return this.animations.some(t=>e<t.startTime+t.duration)}getTotalDuration(){if(0===this.animations.length)return 0;return Math.max(...this.animations.map(e=>e.startTime+e.duration))-Math.min(...this.animations.map(e=>e.startTime))}getActiveAnimations(){const e=Date.now();return this.animations.filter(t=>{const i=e-t.startTime;return i>=0&&i<t.duration})}scheduleExplosion(e,t,i){this.animations=[];const s=Date.now(),a=[];for(let n=e-1;n<=e+1;n++)for(let s=t-1;s<=t+1;s++){const r=i.getCell(n,s);if(r&&r.occupied){const i=Math.abs(n-e)+Math.abs(s-t);a.push({row:n,col:s,distance:i,color:r.color||"#8B4513"})}}a.forEach(({row:e,col:t,distance:i,color:a})=>{const n=i*this.staggerDelay;this.animations.push({row:e,col:t,startTime:s+n,duration:this.animationDuration,color:a}),setTimeout(()=>{const i=t*this.cellSize,s=e*this.cellSize;this.particleSystem.spawnParticles(i,s,this.cellSize,a)},n)})}clear(){this.animations=[],this.particleSystem.clear()}updateParticles(e){this.particleSystem.update(e)}getParticleSystem(){return this.particleSystem}updateCellSize(e){this.cellSize=e}}var Y=(e=>(e.LOADING="LOADING",e.PLAYING="PLAYING",e.PAUSED="PAUSED",e.GAME_OVER="GAME_OVER",e))(Y||{});class H{constructor(){t(this,"dbName","PurrfectBlocksDB"),t(this,"dbVersion",3),t(this,"storeName","gameState"),t(this,"db",null),t(this,"useLocalStorage",!0),t(this,"localStorageKey","purrfectBlocks_gameState")}async init(){this.useLocalStorage=!0;try{localStorage.setItem("[GameStorage] test","test"),localStorage.removeItem("[GameStorage] test")}catch(e){}}async migrateToLocalStorage(){try{if(this.db){const e=await this.loadGame();e&&localStorage.setItem(this.localStorageKey,JSON.stringify(e))}}catch(e){}}initIndexedDB(){return new Promise((e,t)=>{const i=indexedDB.open(this.dbName,this.dbVersion);let s=!1,a=null;const n=()=>{null!==a&&(clearTimeout(a),a=null)};i.onerror=()=>{s||(s=!0,n(),t(i.error))},i.onblocked=()=>{null!==a&&clearTimeout(a),a=window.setTimeout(()=>{s||(s=!0,t(new Error("Database blocked: Please close other tabs with this app open")))},1e4)},i.onsuccess=()=>{s||(s=!0,n(),this.db=i.result,e())},i.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.storeName)&&t.deleteObjectStore(this.storeName),t.createObjectStore(this.storeName,{keyPath:"id"})},a=window.setTimeout(()=>{s||(s=!0,t(new Error("Database initialization timeout")))},1e4)})}async saveGame(e){if(!this.useLocalStorage){if(!this.db)throw new Error("Database not initialized");if(!this.db.objectStoreNames.contains(this.storeName))throw new Error("Database corrupted: object store missing");return new Promise((t,i)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),a={id:"current",...e},n=s.put(a);n.onsuccess=()=>{t()},n.onerror=()=>{i(n.error)}})}try{localStorage.setItem(this.localStorageKey,JSON.stringify(e))}catch(t){throw t}}async loadGame(){if(this.useLocalStorage)try{const e=localStorage.getItem(this.localStorageKey);return e?JSON.parse(e):null}catch(e){return null}if(!this.db)throw new Error("Database not initialized");if(!this.db.objectStoreNames.contains(this.storeName))throw new Error("Database corrupted: object store missing");return new Promise((t,i)=>{try{const e=this.db.transaction([this.storeName],"readonly"),s=e.objectStore(this.storeName).get("current");s.onsuccess=()=>{s.result?t(s.result):t(null)},s.onerror=()=>{i(s.error)},e.onerror=()=>{i(e.error)}}catch(e){i(e)}})}async deleteSave(){if(!this.useLocalStorage){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete("current");i.onsuccess=()=>{e()},i.onerror=()=>{t(i.error)}})}try{localStorage.removeItem(this.localStorageKey)}catch(e){throw e}}async hasSavedGame(){return null!==await this.loadGame()}async resetDatabase(){return new Promise((e,t)=>{this.db&&(this.db.close(),this.db=null),this.dbVersion++;const i=indexedDB.deleteDatabase(this.dbName);i.onsuccess=async()=>{try{await this.init(),e()}catch(i){t(i)}},i.onerror=()=>{this.init().then(e).catch(t)},i.onblocked=()=>{setTimeout(()=>{this.init().then(e).catch(t)},100)}})}}class X{constructor(){t(this,"context",null),t(this,"masterGain",null),t(this,"volume",.5),t(this,"muted",!1)}init(){if(!this.context)try{this.context=new AudioContext,this.masterGain=this.context.createGain(),this.masterGain.connect(this.context.destination),this.masterGain.gain.value=this.volume}catch(e){}}async resume(){this.context&&"suspended"===this.context.state&&await this.context.resume()}setVolume(e){this.volume=Math.max(0,Math.min(1,e)),this.masterGain&&!this.muted&&(this.masterGain.gain.value=this.volume)}getVolume(){return this.volume}setMuted(e){this.muted=e,this.masterGain&&(this.masterGain.gain.value=e?0:this.volume)}isMuted(){return this.muted}playTone(e,t,i="sine"){if(!this.context||!this.masterGain||this.muted)return;const s=this.context.createOscillator(),a=this.context.createGain();s.type=i,s.frequency.value=e;const n=this.context.currentTime;a.gain.setValueAtTime(0,n),a.gain.linearRampToValueAtTime(.3,n+.01),a.gain.linearRampToValueAtTime(.2,n+.05),a.gain.setValueAtTime(.2,n+t-.05),a.gain.linearRampToValueAtTime(0,n+t),s.connect(a),a.connect(this.masterGain),s.start(n),s.stop(n+t)}playChord(e,t,i="sine"){e.forEach(e=>this.playTone(e,t,i))}playNoise(e,t=500){if(!this.context||!this.masterGain||this.muted)return;const i=this.context.sampleRate*e,s=this.context.createBuffer(1,i,this.context.sampleRate),a=s.getChannelData(0);for(let l=0;l<i;l++)a[l]=2*Math.random()-1;const n=this.context.createBufferSource();n.buffer=s;const r=this.context.createBiquadFilter();r.type="lowpass",r.frequency.value=t;const o=this.context.createGain(),c=this.context.currentTime;o.gain.setValueAtTime(.1,c),o.gain.exponentialRampToValueAtTime(.01,c+e),n.connect(r),r.connect(o),o.connect(this.masterGain),n.start(c),n.stop(c+e)}}class V{constructor(e){t(this,"audioEngine"),this.audioEngine=e}playPiecePlaced(){this.audioEngine.playNoise(.08,300)}playLineClear(){let e=0;[{freq:500,duration:.06},{freq:600,duration:.05},{freq:750,duration:.07},{freq:900,duration:.08},{freq:700,duration:.06},{freq:550,duration:.05}].forEach(({freq:t,duration:i})=>{setTimeout(()=>{this.audioEngine.playTone(t,i,"triangle")},e),e+=1e3*i*.7})}playCascade(e){const t=500,i=100*e,s=[t+i,t+i+200,t+i+400];this.audioEngine.playChord(s,.15,"triangle"),setTimeout(()=>{this.audioEngine.playTone(t+i+600,.1,"sine")},80)}playGameOver(){let e=0;[500,400,300,250].forEach(t=>{setTimeout(()=>{this.audioEngine.playTone(t,.2,"triangle")},e),e+=150})}playSuccess(){this.audioEngine.playChord([523,659,784],.3,"sine")}playInvalid(){this.audioEngine.playTone(150,.1,"square")}playBombExplosion(){this.audioEngine.playNoise(.15,4e3),setTimeout(()=>{this.audioEngine.playTone(800,.04,"sawtooth"),this.audioEngine.playTone(600,.04,"sawtooth")},50),setTimeout(()=>{this.audioEngine.playTone(750,.04,"sawtooth"),this.audioEngine.playTone(550,.04,"sawtooth")},100),setTimeout(()=>{this.audioEngine.playTone(700,.05,"sawtooth"),this.audioEngine.playTone(500,.05,"sawtooth"),this.audioEngine.playNoise(.06,200)},150)}}const $=["Meow","Purrr","Mrrrow","Nya","Mew","Purr-fect","Meowdy","Paw-some","Fur-tastic","Whisker-ific"],W=["üêæ","üò∫","üò∏","üòª","üê±","üéÄ","üß∂","üêü"],U=["Mewtastic","Purrfect","Fur-midable","Claw-some","Meow-nificent","Purr-fection","Catastrophic","Feline Fine","Kitty Boom","Yarn Chaos","Paws-itively Explosive"];function j(e){return`${$[Math.floor(Math.random()*$.length)]}, ${e}! ${function(){const e=Math.floor(3*Math.random())+1,t=[];for(let i=0;i<e;i++){const e=W[Math.floor(Math.random()*W.length)];t.push(e)}return t.join(" ")}()}`}class q{constructor(e,i,s){t(this,"board"),t(this,"scoreManager"),t(this,"cascadeEngine"),t(this,"pieceManager"),t(this,"boardRenderer"),t(this,"panelRenderer"),t(this,"effectsRenderer"),t(this,"hudRenderer"),t(this,"animationLoop"),t(this,"inputManager"),t(this,"gameState",Y.LOADING),t(this,"effects",[]),t(this,"animatingCascade",!1),t(this,"clearAnimationManager"),t(this,"gameStorage"),t(this,"autoSaveTimeout",null),t(this,"storageAvailable",!1),t(this,"audioEngine"),t(this,"soundEffects"),this.board=new g,this.scoreManager=new m,this.cascadeEngine=new p,this.pieceManager=new I,this.boardRenderer=new B(e);const a=this.boardRenderer.getCellSize();this.panelRenderer=new A(i,a),this.effectsRenderer=new R(s,a),this.hudRenderer=new z;const n=window.innerWidth<768;this.clearAnimationManager=new _(a,n),this.setupEffectsCanvas(s),this.inputManager=new N(e,a),this.inputManager.setPanelCanvas(i),this.inputManager.setCallbacks(this.handlePiecePlaced.bind(this),this.handlePieceSelected.bind(this)),i.addEventListener("mousedown",this.handlePanelClick.bind(this)),i.addEventListener("touchstart",this.handlePanelTouch.bind(this),{passive:!1}),document.addEventListener("touchmove",this.handleGlobalTouchMove.bind(this),{passive:!1}),document.addEventListener("touchend",this.handleGlobalTouchEnd.bind(this),{passive:!1}),document.addEventListener("touchcancel",this.handleGlobalTouchEnd.bind(this),{passive:!1}),this.animationLoop=new k(this.update.bind(this)),this.gameStorage=new H,this.audioEngine=new X,this.audioEngine.init(),this.soundEffects=new V(this.audioEngine),document.addEventListener("click",()=>{this.audioEngine.resume()},{once:!0}),this.setupAudioTestButtons(),this.init()}setupEffectsCanvas(e){const t=document.querySelector(".game-area");if(!t)return;const i=t.getBoundingClientRect();e.width=i.width,e.height=i.height,e.style.width=`${i.width}px`,e.style.height=`${i.height}px`}async init(){try{await this.gameStorage.init(),this.storageAvailable=!0}catch(i){this.storageAvailable=!1}const e=localStorage.getItem("purrfectBlocksHighScore"),t=e?parseInt(e):0;if(this.hudRenderer.updateHighScore(t),this.storageAvailable)try{const e=await this.gameStorage.loadGame();e&&this.restoreGameState(e)}catch(i){}this.gameState=Y.PLAYING;this.pieceManager.getAvailablePieces();this.animationLoop.start(),this.render()}setupAudioTestButtons(){[{id:"test-piece-placed",handler:()=>this.soundEffects.playPiecePlaced()},{id:"test-line-clear",handler:()=>this.soundEffects.playLineClear()},{id:"test-bomb-explosion",handler:()=>this.soundEffects.playBombExplosion()},{id:"test-cascade-2x",handler:()=>this.soundEffects.playCascade(2)},{id:"test-cascade-3x",handler:()=>this.soundEffects.playCascade(3)},{id:"test-cascade-4x",handler:()=>this.soundEffects.playCascade(4)},{id:"test-game-over",handler:()=>this.soundEffects.playGameOver()},{id:"test-success",handler:()=>this.soundEffects.playSuccess()},{id:"test-invalid",handler:()=>this.soundEffects.playInvalid()}].forEach(({id:e,handler:t})=>{const i=document.getElementById(e);i&&i.addEventListener("click",t)})}update(e){if(this.gameState!==Y.PLAYING)return;const t=this.inputManager.getDragHandler();if(t.isDragging()){const e=t.getDragState();t.updateDrag(e.currentX,e.currentY,this.board,this.boardRenderer.getCellSize())}this.updateEffects(e),this.render()}render(){this.renderBoardWithAnimations(),this.panelRenderer.render(this.pieceManager.getAvailablePieces(),this.pieceManager.getSelectedIndex());const e=this.clearAnimationManager.getParticleSystem().getParticles();this.effectsRenderer.render(this.effects,e),this.renderDraggedPiece(),this.hudRenderer.updateScore(this.scoreManager.getScore()),this.hudRenderer.updateCombo(this.scoreManager.getComboMultiplier())}renderBoardWithAnimations(){const e=this.board.getCells(),t=this.boardRenderer.ctx;this.boardRenderer.getCellSize(),L(t),this.boardRenderer.drawGrid();for(let i=0;i<e.length;i++)for(let t=0;t<e[i].length;t++){const s=e[i][t];if(s.occupied&&s.color){const e=this.clearAnimationManager.getBlockProgress(i,t);null!==e&&e<1?this.boardRenderer.drawCellWithAnimation(i,t,s.color,e):null===e&&this.boardRenderer.drawCell(i,t,s.color)}}}renderDraggedPiece(){const e=this.inputManager.getDragHandler().getDragState();if(e.isDragging&&e.piece){const t=this.effectsRenderer.ctx,i=this.boardRenderer.getCellSize();t.clearRect(0,0,t.canvas.width,t.canvas.height);const s=document.querySelector(".game-area"),a=this.boardRenderer.ctx.canvas;if(s&&a){const n=s.getBoundingClientRect(),r=a.getBoundingClientRect(),o=r.left-n.left,c=r.top-n.top;t.save(),t.translate(o,c),O.render(t,e.piece.shape,e.gridRow,e.gridCol,i,e.isValid,e.piece.color,this.board.getCells()),t.restore();const l=1*i,h=D.getPieceDimensions(e.piece.shape,l),d=e.isTouch?.25*-h.width:0,u=e.isTouch?.25*-h.height:0;D.renderPiece(t,e.piece,e.currentX+o-.5*i+d,e.currentY+c-.5*i+u,l,.8)}}}handlePanelClick(e){if(this.gameState!==Y.PLAYING)return;const t=e.currentTarget.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top,a=this.panelRenderer.getSlotIndexFromCoordinates(i,s);if(a>=0){const t=this.pieceManager.selectPiece(a);t&&this.inputManager.startDragFromPanel(t,e)}}handlePanelTouch(e){if(this.gameState!==Y.PLAYING)return;if(e.preventDefault(),0===e.touches.length)return;const t=e.touches[0],i=e.currentTarget.getBoundingClientRect(),s=t.clientX-i.left,a=t.clientY-i.top,n=this.panelRenderer.getSlotIndexFromCoordinates(s,a);if(n>=0){const e=this.pieceManager.selectPiece(n);if(e){const i={clientX:t.clientX,clientY:t.clientY};this.inputManager.startDragFromPanel(e,i,!0)}}}handleGlobalTouchMove(e){const t=this.inputManager.getDragHandler();if(!t.isDragging())return;if(e.preventDefault(),0===e.touches.length)return;const i=e.touches[0],s=this.boardRenderer.getCanvas().getBoundingClientRect(),a=i.clientX-s.left,n=i.clientY-s.top;t.dragState.currentX=a,t.dragState.currentY=n}handleGlobalTouchEnd(e){const t=this.inputManager.getDragHandler();if(!t.isDragging())return;e.preventDefault();const i=t.endDrag();i&&this.handlePiecePlaced(i.piece,i.row,i.col)}handlePieceSelected(e){this.pieceManager.selectPiece(e)}handlePiecePlaced(e,t,i){if(this.animatingCascade)return;this.soundEffects.playPiecePlaced();const s=e instanceof b;this.board.placePiece(e.shape,t,i,e.color,e.id);const a=this.pieceManager.getSelectedIndex();a>=0&&this.pieceManager.consumePiece(a),s&&this.handleBombExplosion(t,i),this.processCascadeWithAnimation()}async handleBombExplosion(e,t){await this.delay(150),this.clearAnimationManager.scheduleExplosion(e,t,this.board),this.soundEffects.playBombExplosion();this.clearAnimationManager.getTotalDuration(),Date.now();for(;this.clearAnimationManager.isAnimating();)await this.delay(16);const i=this.board.explode3x3(e,t);if(i>0){const e=this.scoreManager.addExplosionScore(i),t=U[Math.floor(Math.random()*U.length)];this.hudRenderer.showMessage(`${t}! +${e}`)}this.clearAnimationManager.clear(),await this.delay(100)}async processCascadeWithAnimation(){this.animatingCascade=!0,this.cascadeEngine.reset(),await this.delay(200);let e=0;for(;;){const t=this.cascadeEngine.detectLines(this.board);if(!t)break;this.soundEffects.playLineClear(),this.clearAnimationManager.scheduleClearing(t.rows,t.cols,this.board);this.clearAnimationManager.getTotalDuration(),Date.now();for(;this.clearAnimationManager.isAnimating();)await this.delay(16);e+=this.cascadeEngine.clearLines(this.board,t),this.clearAnimationManager.clear(),await this.delay(100)}if(e>0){const t=this.cascadeEngine.getCascadeLevel(),i=this.scoreManager.addScore(e,t);t>1&&(this.soundEffects.playCascade(t),this.hudRenderer.showMessage(`${t}x CASCADE! +${i}`))}else this.scoreManager.resetCombo();this.animatingCascade=!1,this.scheduleAutoSave(),this.pieceManager.hasPlayablePieces(this.board)||this.gameOver()}updateEffects(e){this.effects=this.effects.filter(t=>(t.progress+=e/1e3,t.progress<1)),this.clearAnimationManager.updateParticles(e)}delay(e){return new Promise(t=>setTimeout(t,e))}async gameOver(){this.gameState=Y.GAME_OVER,this.animationLoop.stop(),this.soundEffects.playGameOver();const e=this.scoreManager.getScore(),t=localStorage.getItem("purrfectBlocksHighScore"),i=t?parseInt(t):0,s=Math.max(e,i);s>i&&(localStorage.setItem("purrfectBlocksHighScore",s.toString()),this.hudRenderer.updateHighScore(s)),await this.delay(200),this.showGameOverModal(e,s)}showGameOverModal(e,t){const i=document.getElementById("game-over-modal"),s=document.getElementById("final-score"),a=document.getElementById("high-score"),n=document.getElementById("play-again-btn"),r=document.getElementById("modal-close-btn");if(i&&s&&a&&n&&r){s.textContent=e.toString(),a.textContent=t.toString(),i.classList.remove("hidden");const o=()=>{i.classList.add("hidden"),this.restart()};n.onclick=o,r.onclick=o}}scheduleAutoSave(){null!==this.autoSaveTimeout&&clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=window.setTimeout(()=>{this.saveGame(),this.autoSaveTimeout=null},300)}async saveGame(){if(this.storageAvailable)try{const e={board:this.board.getCells().map(e=>e.map(e=>e.occupied?1:0)),score:this.scoreManager.getScore(),combo:this.scoreManager.getComboMultiplier(),availablePieces:this.pieceManager.getAvailablePieces().map(e=>({shape:e.shape,color:e.color,id:e.id})),timestamp:Date.now()};await this.gameStorage.saveGame(e)}catch(e){this.storageAvailable=!1}}restoreGameState(e){try{const t=e.board,i=this.board.getCells();for(let e=0;e<t.length&&e<i.length;e++)for(let s=0;s<t[e].length&&s<i[e].length;s++)1===t[e][s]&&this.board.placePiece([[!0]],e,s,"#D84315",`restored-${e}-${s}`);this.scoreManager.score=e.score,this.scoreManager.comboMultiplier=e.combo}catch(t){}}restart(){this.board.clear(),this.scoreManager.reset(),this.cascadeEngine.reset(),this.pieceManager.reset(),this.effects=[],this.animatingCascade=!1,this.gameState=Y.PLAYING,this.gameStorage.deleteSave().catch(e=>{}),this.animationLoop.start(),this.render()}getAudioEngine(){return this.audioEngine}pause(){this.gameState===Y.PLAYING&&(this.gameState=Y.PAUSED,this.animationLoop.stop())}resume(){this.gameState===Y.PAUSED&&(this.gameState=Y.PLAYING,this.animationLoop.start())}isPaused(){return this.gameState===Y.PAUSED}}const K="playerSettings";class Z{constructor(){t(this,"db",null)}async init(){return new Promise((e,t)=>{const i=indexedDB.open("PurrfectBlocksDB",2);let s=!1;i.onerror=()=>{s||(s=!0,t(new Error("Failed to open IndexedDB")))},i.onsuccess=()=>{s||(s=!0,this.db=i.result,e())},i.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(K)||t.createObjectStore(K,{keyPath:"id"})},i.onblocked=()=>{},setTimeout(()=>{s||(s=!0,t(new Error("PlayerSettings DB initialization timeout")))},1e4)})}async getPlayerSettings(e="default"){return this.db||await this.init(),this.db&&this.db.objectStoreNames.contains(K)?new Promise((t,i)=>{try{const s=this.db.transaction([K],"readonly"),a=s.objectStore(K).get(e);a.onsuccess=()=>{t(a.result||null)},a.onerror=()=>{i(new Error("Failed to get player settings"))}}catch(s){t(null)}}):null}async savePlayerSettings(e){if(this.db||await this.init(),this.db&&this.db.objectStoreNames.contains(K))return new Promise((t,i)=>{try{const s=this.db.transaction([K],"readwrite"),a=s.objectStore(K).put(e);a.onsuccess=()=>{t()},a.onerror=()=>{i(new Error("Failed to save player settings"))}}catch(s){i(s)}})}}let J,Q,ee=null;function te(){const e=document.getElementById("player-name-input"),t=document.getElementById("player-uuid"),i=document.getElementById("volume-slider"),s=document.getElementById("volume-value"),a=document.getElementById("mute-toggle"),n=document.getElementById("dev-mode-checkbox");if(e&&(e.value=Q.name),t&&(t.textContent=Q.uuid),i&&s){const e=Q.volume||70;i.value=e.toString(),s.textContent=`${e}%`}if(a){const e=Q.muted||!1;a.textContent=e?"üîá":"üîä"}n&&(n.checked=Q.devMode||!1)}function ie(){const e=document.getElementById("dev-tools-area");e&&(Q.devMode?e.classList.remove("hidden"):e.classList.add("hidden"))}function se(){const e=document.getElementById("player-greeting");e&&(e.textContent=j(Q.name))}async function ae(){await async function(){J=new Z,await J.init();let e=await J.getPlayerSettings();e||(e={id:"default",name:"Player",uuid:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),volume:70,muted:!1},await J.savePlayerSettings(e)),void 0===e.volume&&(e.volume=70),void 0===e.muted&&(e.muted=!1),Q=e,te(),se(),ie()}();const e=document.getElementById("board-canvas"),t=document.getElementById("panel-canvas"),i=document.getElementById("effects-canvas");if(!e||!t||!i)throw new Error("Canvas elements not found");ee=new q(e,t,i);const s=document.getElementById("restart-btn");s&&s.addEventListener("click",()=>{ee.restart()});const a=document.getElementById("fullscreen-btn"),n=document.getElementById("exit-fullscreen-btn");a&&a.addEventListener("click",()=>{document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen()}),n&&n.addEventListener("click",()=>{document.exitFullscreen&&document.exitFullscreen()}),document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?(a&&(a.style.display="none"),n&&(n.style.display="inline-block")):(a&&(a.style.display="inline-block"),n&&(n.style.display="none"))});const r=document.getElementById("settings-btn-top"),o=document.getElementById("settings-modal"),c=document.getElementById("settings-close-btn"),l=document.getElementById("save-settings-btn"),h=()=>{te();const e=Q.volume||70,t=Q.muted||!1;ee.getAudioEngine().setVolume(e/100),ee.getAudioEngine().setMuted(t),o&&o.classList.add("hidden")};r&&o&&r.addEventListener("click",()=>{o.classList.remove("hidden"),te()}),c&&o&&(c.addEventListener("click",()=>{h()}),o.addEventListener("click",e=>{e.target===o&&h()})),l&&l.addEventListener("click",async()=>{const e=document.getElementById("player-name-input"),t=document.getElementById("volume-slider"),i=document.getElementById("mute-toggle"),s=document.getElementById("dev-mode-checkbox"),a=e.value.trim()||"Player",n=t?parseInt(t.value):70,r="üîá"===(null==i?void 0:i.textContent),c=(null==s?void 0:s.checked)||!1;Q.name=a,Q.volume=n,Q.muted=r,Q.devMode=c,await J.savePlayerSettings(Q),se(),ie(),o&&o.classList.add("hidden")});const d=document.getElementById("volume-slider"),u=document.getElementById("volume-value");if(d&&u){const e=Q.volume||70;d.value=e.toString(),u.textContent=`${e}%`,ee.getAudioEngine().setVolume(e/100),d.addEventListener("input",()=>{const e=parseInt(d.value);u.textContent=`${e}%`,ee.getAudioEngine().setVolume(e/100)})}const g=document.getElementById("mute-toggle");if(g){const e=Q.muted||!1;g.textContent=e?"üîá":"üîä",ee.getAudioEngine().setMuted(e),g.addEventListener("click",()=>{const e=!("üîá"===g.textContent);ee.getAudioEngine().setMuted(e),g.textContent=e?"üîá":"üîä"})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",ae):ae();
